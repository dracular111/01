local sources = {
    { name = "FPS", url = "https://raw.githubusercontent.com/dracular111/01/main/FPS" },
    { name = "Gift-gem", url = "https://raw.githubusercontent.com/dracular111/01/main/Gift-Gem" }
    { name = "Script-Reset", url = "https://raw.githubusercontent.com/dracular111/01/main/Script-Reset" }
    --{ name = "Gift-Item", url = "https://raw.githubusercontent.com/dracular111/01/main/Gift-Item" }

}

local http = game:GetService("HttpService")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AutoUpdaterUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = game:GetService("CoreGui")

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 260, 0, (#sources * 22) + 30)
Frame.Position = UDim2.new(1, -270, 1, -Frame.Size.Y.Offset - 20)
Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Frame.BackgroundTransparency = 0.2
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0, 5)
UIListLayout.FillDirection = Enum.FillDirection.Vertical
UIListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
UIListLayout.VerticalAlignment = Enum.VerticalAlignment.Top
UIListLayout.Parent = Frame

local Title = Instance.new("TextLabel")
Title.Text = "üîÅ Auto Script Updater"
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1, 0, 0, 25)
Title.Parent = Frame

-- üß© H√†m ti·ªán √≠ch
local function log(label, text)
    label.Text = text
end

-- ‚öôÔ∏è H√†m t·∫£i script c√≥ ch·ªëng cache
local function fetchCode(url)
    local success, result = pcall(function()
        return game:HttpGet(url .. "?nocache=" .. tick())
    end)
    if success then
        return result
    else
        return nil, result
    end
end

-- ‚öôÔ∏è H√†m ch·∫°y code an to√†n
local function safeRun(code, scriptName)
    local f, err = loadstring(code)
    if not f then
        warn(string.format("[Loader:%s] L·ªói bi√™n d·ªãch: %s", scriptName, err))
        return false, err
    end
    local success, execErr = pcall(f)
    if not success then
        warn(string.format("[Loader:%s] L·ªói khi ch·∫°y: %s", scriptName, execErr))
        return false, execErr
    end
    return true
end

-- üß† L∆∞u th√¥ng tin script
local scripts = {}

for _, src in ipairs(sources) do
    local lbl = Instance.new("TextLabel")
    lbl.Font = Enum.Font.SourceSans
    lbl.TextSize = 16
    lbl.TextColor3 = Color3.fromRGB(220, 220, 220)
    lbl.BackgroundTransparency = 1
    lbl.Size = UDim2.new(1, -10, 0, 20)
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.Parent = Frame
    lbl.Text = string.format("%s: ƒêang t·∫£i...", src.name)

    scripts[src.name] = {
        url = src.url,
        label = lbl,
        lastCode = nil,
        backup = nil,
        lastUpdate = "Ch∆∞a c·∫≠p nh·∫≠t"
    }

    -- üî• Ch·∫°y l·∫ßn ƒë·∫ßu
    task.spawn(function()
        local code, err = fetchCode(src.url)
        if not code then
            log(lbl, src.name .. ": ‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c (" .. tostring(err) .. ")")
            return
        end
        scripts[src.name].lastCode = code
        local ok = safeRun(code, src.name)
        if ok then
            scripts[src.name].lastUpdate = os.date("%H:%M:%S")
            log(lbl, string.format("%s: ‚úÖ ƒê√£ ch·∫°y ‚Ä¢ %s", src.name, scripts[src.name].lastUpdate))
        else
            log(lbl, src.name .. ": ‚ö†Ô∏è L·ªói khi ch·∫°y")
        end
    end)
end

-- üîÅ Theo d√µi thay ƒë·ªïi m·ªói 20 gi√¢y + rollback n·∫øu l·ªói
task.spawn(function()
    while task.wait(20) do
        for name, data in pairs(scripts) do
            task.wait(5) -- ‚è± delay gi·ªØa m·ªói request cho an to√†n
            local newCode, err = fetchCode(data.url)
            if not newCode then
                log(data.label, name .. ": ‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c (" .. tostring(err) .. ")")
                continue
            end

            if newCode ~= data.lastCode then
                log(data.label, name .. ": ‚ôªÔ∏è Ph√°t hi·ªán thay ƒë·ªïi, reload...")
                data.backup = data.lastCode -- backup b·∫£n c≈©
                local ok = safeRun(newCode, name)
                if ok then
                    data.lastCode = newCode
                    data.lastUpdate = os.date("%H:%M:%S")
                    log(data.label, string.format("%s: ‚úÖ Reload th√†nh c√¥ng ‚Ä¢ %s", name, data.lastUpdate))
                else
                    -- rollback l·∫°i b·∫£n c≈©
                    log(data.label, name .. ": ‚ö†Ô∏è L·ªói b·∫£n m·ªõi, kh√¥i ph·ª•c b·∫£n c≈©")
                    safeRun(data.backup, name)
                end
            else
                -- üïí Gi·ªØ nguy√™n th·ªùi gian c≈©
                log(data.label, string.format("%s: üïí ‚Ä¢ %s", name, data.lastUpdate))
            end
        end
    end
end)
