-- reset guard náº¿u cáº§n cháº¡y láº¡i
_G.VAR_SIMPLE_HUD = nil
if _G.VAR_SIMPLE_HUD then return end
_G.VAR_SIMPLE_HUD = true

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local Save = require(ReplicatedStorage.Library.Client.Save)

-- ===== Utilities =====
local function Format(n)
    if type(n) ~= "number" then return "0" end
    local suffix = {"","K","M","B","T","Qd","Qn","Sx","Sp","Oc"}
    local i = 1
    while n >= 1000 and i < #suffix do
        n = n / 1000
        i += 1
    end
    return string.format("%.2f%s", n, suffix[i])
end

local function TryGetSave()
    local ok, data = pcall(Save.Get)
    if ok and type(data) == "table" then
        return data
    end
    return nil
end

-- Láº¥y Diamonds an toÃ n (tráº£ vá» sá»‘ hoáº·c nil náº¿u chÆ°a sáºµn sÃ ng)
local function GetGems()
    local data = TryGetSave()
    if not data or not data.Inventory then return nil end
    local cur = data.Inventory.Currency
    if not cur then return nil end

    -- há»— trá»£ cáº£ máº£ng vÃ  dictionary
    if typeof(cur) == "table" then
        -- dáº¡ng máº£ng
        for _, v in pairs(cur) do
            if type(v) == "table" and (v.id == "Diamonds" or v.id == "Gems") then
                return tonumber(v._am) or 0
            end
        end
        -- dáº¡ng dictionary
        local node = cur.Diamonds or cur["Diamonds"] or cur.Gems or cur["Gems"]
        if type(node) == "table" then
            return tonumber(node._am) or tonumber(node.amount) or 0
        end
    end
    return 0
end

-- ===== GUI =====
-- cleanup cÅ© náº¿u cÃ³
local old = playerGui:FindFirstChild("GEM_HUD")
if old then old:Destroy() end

local ui = Instance.new("ScreenGui")
ui.Name = "GEM_HUD"
ui.Parent = playerGui
ui.ResetOnSpawn = false
ui.IgnoreGuiInset = true
ui.ZIndexBehavior = Enum.ZIndexBehavior.Global

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 900, 0, 200)
frame.Position = UDim2.new(0.5, -450, 1, -300) -- giá»¯a, nÃ¢ng lÃªn ~6 dÃ²ng
frame.BackgroundTransparency = 1
frame.ZIndex = 9999
frame.Parent = ui

local function newText(size, y)
    local t = Instance.new("TextLabel")
    t.Size = UDim2.new(1, 0, 0, size + 10)
    t.Position = UDim2.new(0, 0, 0, y)
    t.BackgroundTransparency = 1
    t.TextColor3 = Color3.new(1,1,1)
    t.Font = Enum.Font.GothamBold
    t.TextSize = size
    t.TextXAlignment = Enum.TextXAlignment.Center
    t.ZIndex = 9999
    t.Parent = frame
    return t
end

local gemLine  = newText(80, 0)     -- ğŸ’ current + ğŸ’+gain (cÃ¹ng dÃ²ng)
local infoLine = newText(60, 120)   -- RANK | RB | ZONE

-- baseGems chá»‰ gÃ¡n khi Ä‘á»c Ä‘Æ°á»£c gems láº§n Ä‘áº§u
local baseGems = nil
local gainedGems = 0

-- chá» nháº¹ cho tá»›i khi cÃ³ dá»¯ liá»‡u (khÃ´ng lá»—i náº¿u cháº­m)
task.spawn(function()
    while task.wait(0.25) do
        local data = TryGetSave()
        local gems = GetGems() -- cÃ³ thá»ƒ nil láº§n Ä‘áº§u -> xá»­ lÃ½ bÃªn dÆ°á»›i

        if type(gems) == "number" then
            if not baseGems then
                baseGems = gems
            end
            if baseGems and gems > baseGems then
                gainedGems = gems - baseGems
            end
            gemLine.Text = "ğŸ’ " .. Format(gems) .. "    ğŸ’+" .. Format(gainedGems)
        else
            -- chÆ°a sáºµn sÃ ng: hiá»ƒn thá»‹ chá»
            gemLine.Text = "ğŸ’ --    ğŸ’+--"
        end

        local rank = 0; local rb = 0; local zone = 0
        if data then
            rank = data.Rank or data.RankLevel or 0
            rb   = data.TileRebirth or data.Rebirths or 0
            zone = data.Zone or 0
        end
        infoLine.Text = string.format("RANK: %s   |   RB: %s   |   ZONE: %s", rank, rb, zone)
    end
end)
