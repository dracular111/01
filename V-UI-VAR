-- reset guard n·∫øu c·∫ßn ch·∫°y l·∫°i
if _G.VAR_SIMPLE_HUD then return end
_G.VAR_SIMPLE_HUD = true

repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- === LOAD SAVE SAFE ===
local Library = ReplicatedStorage:WaitForChild("Library", 99999)
local Client = Library:WaitForChild("Client", 99999)
local Save

for _, m in pairs(getloadedmodules()) do
    if m.Name == "Save" then
        local ok, result = pcall(require, m)
        if ok and type(result) == "table" then Save = result break end
    end
end
if not Save then Save = require(Client:WaitForChild("Save")) end

-- Map Names
local placeNames = {
    [8737899170] = "World 1",
    [16498369169] = "World 2",
    [17473989780] = "World 3",
    [140403681187145] = "World 4",
    [119454325063278] = "Farming World",
    [95635359880599] = "Fishing World",
    [131952481663528] = "Halloween Event",
    [15588442388] = "Plaza",
    [15502339080] = "Plaza (Alt)"
}
local function GetMap()
    return placeNames[game.PlaceId] or ("PlaceId: " .. game.PlaceId)
end

-- ‚úÖ Format s·ªë theo ƒë√∫ng rule b·∫°n x√°c nh·∫≠n
local function Format(n)
    if type(n) ~= "number" then return "0" end

    if n < 100000 then
        return tostring(math.floor(n))
    end

    local s = {"","K","M","B","T","Qd","Qn","Sx","Sp","Oc"}
    local i = 1
    while n >= 1000 and i < #s do
        n = n / 1000
        i += 1
    end

    if i == 2 then
        return string.format("%d%s", math.floor(n), s[i])
    end

    local out = string.format("%.1f%s", n, s[i])
    return out:gsub("%.0", "")
end

local function TryGetSave()
    local ok,data = pcall(Save.Get)
    return (ok and type(data)=="table") and data or nil
end

local function GetGems()
    local d = TryGetSave()
    if not d or not d.Inventory or not d.Inventory.Currency then return 0 end
    for _,v in pairs(d.Inventory.Currency) do
        if v.id=="Diamonds" or v.id=="Gems" then
            return tonumber(v._am) or 0
        end
    end
    return 0
end

-- GUI
local old = playerGui:FindFirstChild("GEM_HUD")
if old then old:Destroy() end

local ui = Instance.new("ScreenGui", playerGui)
ui.Name = "GEM_HUD"
ui.IgnoreGuiInset = true
ui.ResetOnSpawn = false

local frame = Instance.new("Frame", ui)
frame.Size = UDim2.new(0, 900, 0, 180)
frame.Position = UDim2.new(0.5, -450, 1, -260)
frame.BackgroundTransparency = 1

-- ‚úÖ Text v√†ng + vi·ªÅn ƒëen ƒë·∫≠m + outline
local function newTxt(size, y)
    local l = Instance.new("TextLabel", frame)
    l.Size = UDim2.new(1,0,0,size+12)
    l.Position = UDim2.new(0,0,0,y)
    l.BackgroundTransparency = 1
    l.Font = Enum.Font.GothamBold
    l.TextColor3 = Color3.fromRGB(255, 225, 0) -- v√†ng neon
    l.TextXAlignment = Enum.TextXAlignment.Center
    l.TextSize = size

    local stroke = Instance.new("UIStroke", l)
    stroke.Thickness = 3.5
    stroke.Color = Color3.new(0,0,0)
    stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Outline -- ‚≠ê quan tr·ªçng nh·∫•t

    return l
end

local line1 = newTxt(66, 0)
local line2 = newTxt(66, 88)

local baseGems, gained = nil, 0
local startGems, startTick = nil, os.clock()
local gemsPerMin = 0

task.spawn(function()
    while task.wait(0.25) do
        local data = TryGetSave()
        local gems = GetGems()

        if not baseGems then baseGems = gems end
        if gems >= baseGems then gained = gems - baseGems end

        if not startGems then startGems = gems end
        local elapsed = os.clock() - startTick
        if elapsed >= 60 then
            gemsPerMin = gems - startGems
            startGems = gems
            startTick = os.clock()
        end

        local rank = data and (data.Rank or data.RankLevel) or 0
        local rb   = data and (data.Rebirth or data.Rebirths or data.TileRebirth or 0) or 0

        line1.Text = string.format("üíé %s | + %s | %s/M", Format(gems), Format(gained), Format(gemsPerMin))
        line2.Text = string.format("üåç %s | RANK: %s | RB: %s", GetMap(), rank, rb)
    end
end)
